# SQL Notes

## Important notes and links

---

---

## 1.1 Введение

### Чем займемся на этом курсе

1. Как эффективно использовать базы данных
2. Как проектировать базы данных под конкретные задачи
3. Как обеспечить стабильную работу с СУБД
4. Как анализировать производительность запросов
5. Станем мастерами SQL

### Где используются БД?

* Любые сервисы с долгосрочным хранением данных
* Фронтенд-приложения
* Мобильные приложения

### Зачем разработчику разбираться в БД?

* БД используются везде
* Нестареющий навык, нужный на интервью
* Разработчику понадобится на ежедневной работе

### Содержание курса: основные моменты

Содержание не соответствуют реальной структуре курса.

1. Самые популярные реляционные СУБД
2. Практика SQL
3. Проектирование БД
4. Анализ и оптимизация SQL-запросов
5. Особенности разработки с использованием БД: ORM, Query Builder
6. Популярные NoSQL решения: MongoDB, Redis

## 1.2 Разные виды БД, язык SQL

**Базы данных** - это данные, организованные по некоторым правилам и
которыми можно управлять по некоторым правилам.

**Система управления базами данных (СУБД)** - это программное средство,
которое позволяет обеспечить создание и использование базы данных.

Файловая система - тоже может считаться СУБД.  
Файлы с данными в этом случае - БД.
Такая БД будет иерархическая.

### Иерархические БД

* Простая реализация
* Понятная структура
* Ограничение на связи узлов

### Графовые БД

* Нет ограничений на связи узлов
* Сложно поддерживать целостность
* Больше данных - больше сложность структуры

### Реляционные БД

* Простая структура
* Гибкость проектирования БД (всё в плоских табличках)

Structured Query Language - декларативный "язык структурированных запросов"
до сих пор ассоциирующийся с реляционными базами данных.

### Объектно-ориентированные базы данных

* Сложные объекты, но гибкие по структуре
* Частный случай - документоориентированные БД

### MongoDB

* Документоориентированная СУБД
* Популярна для задач хранения слабо структурированных данных
* Хорошо масштабируется

### СУБД типа ключ - значение

* Создаются под узкую задачу
* Пример: Redis - самая быстрая СУБД (хранит все данные в оперативной памяти)

### СУБД типа семейство столбцов

* Аналитические БД с большим объемом данных
* Примеры: Apache Cassandra, ClickHouse от Яндекса

## 1.5 WHERE: Фильтрация результата

В MySQL по факту нет значения boolean оно конвертируется в TINYINT.

## 2.2 Сложные типы данных

`BLOB` - тип для хранения бинарных данных

В MySQL можно хранить данные JSON и XML.

`cast(100.99 as signed)` - преобразование типов

## 2.3 Соединение и уникальность результатов

Для объединения результатов запросов по вертикали нужно использовать оператор `UNION`.

```mysql
SELECT column_name(s) FROM table1
UNION
SELECT column_name(s) FROM table2;
```

`UNION ALL` оставляет дубли в отличие от `UNION`.

Также есть операторы `INTERSECT` и `MINUS` (или `EXCEPT`), но в MySQL
они не поддерживаются, зато поддерживаются в PostgreSQL.

## 2.4 Сортировка и ограничение результата запроса

Сортировать можно по номеру столбца `ORDER BY 1, 3`.

## 2.5 Подготовка запросов с WITH

Подзапросы можно создавать с помощью оператора `WITH`.

```mysql
WITH
  cte1 AS (SELECT a, b FROM table1),
  cte2 AS (SELECT c, d FROM table2)
SELECT b, d FROM cte1 JOIN cte2
WHERE cte1.a = cte2.c;
```

Подзапросы можно выполнять рекурсивно с помощью `WITH RECURSIVE`.

## 3.4 Введение (понятие индексов)

### Страница памяти

* Универсальная организация менеджмента памяти
* Уменьшают количество I/O операций
* Размер страницы один на всю БД 4-64 кБ

### Типы страниц

* Записи
* Индексы
* Бинарные данные
* Экстенты (расширения)
* Метаданные (адреса свободных страниц, экстентов)

## 3.5 Индексация таблиц

`CREATE INDEX idx_name ON employees (first_name);` - создание индекса

`DROP INDEX idx_name ON employees (first_name);` - удаление индекса

Индекс может включать в себя несколько столбцов.

**Недостатки и особенности индексов**:

* Индексы замедляют работу при записи
* Индексы занимают дополнительное место на диске
* Удаление индекса может привести к нарушению целостности данных

Поэтому нужно создавать индексы, только когда это действительно необходимо.

## 3.6 Explain (создание индексов)

`EXPLAIN SELECT * FROM employees WHERE department = 'Sales';` - информация
о запросе

Индексам можно задавать размер страницы, с помощью `KEY_BLOCK_SIZE`.

Индексы могут быть по хешу или сбалансированному дереву.

## 4.2 Порядок выполнения запроса

`DATE_SUB(NOW(), INTERVAL 2 YEAR)` - создание пограничной даты за определенный
интервал

## 4.3 Первичные ключи

### Виды ключей

* Primary key
* Foreign key
* Unique key
* Natural key - поле которое идентифицирует запись естественным образом
  (например номер ИНН)

## 6.1 Архитектура современных СУБД

### Менеджеры в СУБД

* Занимаются одной задачей на одном уровне
* Минимально взаимодействуют с другими системами
* Работают только с ресурсами на своём уровне абстракции

### Буферы

* Страницы данных, загруженные в память
* Доступ к кешам
* Метаданные различных процессов в СУБД
* Протоколы обмена данными между компонентами

## 6.2 Оптимизация запросов

### Оптимизация выполнения запроса

* Вычисления и ввод-вывод - основные операции в СУБД
* EXPLAIN, индексы и хинты - базовая оптимизация запросов
* Добавление памяти, CPU и настройка размера кеша
* Проектирование схемы БД и создание материализованных представлений с учётом
  типичных запросов

### Встроенные механизмы оптимизации

* Повторное использование кеша уже выполненных запросов
* Параллельная обработка независимых частей запроса

## 6.3 Особенности MySQL

### Что такое и зачем нужен MySQL?

* СУБД для веба по умолчанию
* Linux + Apache + MySQL + PHP (LAMP)
* Хорош для старта, есть потенциал масштабирования
* Можно дописывать, когда сервис станет высоконагруженным

### Движки InnoDB, MyISAM, MyRocks

* InnoDB - Высокопроизводительный, поддержка транзакции с точками сохранения.
  Медленный, но универсальный.
* MyISAM (+Aria) - Оптимизирован под интенсивное чтение, но не запись.
  Не поддерживают транзакции и внешние ключи.
* MyRocks - Оптимизирует место на диске, оптимизирован под интенсивную запись;
  Написан Facebook

Даже различные базы данных в одной СУБД можно переключить на использование
других движков.

### MariaDB

* Форк совместимый в большинстве случаев, включая движки
* Нет функциональности последних версий (работа с геоданными)
* Полностью свободен; Не Oracle

### Различия синтаксиса MySQL

* Названия таблиц, атрибутов в кавычках - <code>\`table_name\`</code>
* Ключевое слово - `auto_increment`
* Работа с датами и временем - `CURDATE()`, `CURTIME()`
* Нет `INTERSECT` и `MINUS`

## 6.4 Особенности Oracle

### Oracle

* Топ-1 среди СУБД для больших корпораций
* Экосистема для разработки приложений и сервисов
* Хорошая масштабируемость, гибкая настройка оптимизаций, ориентация на
  большие данные
* Платная, дорогая, закрытая (может себе это позволить)

### PL/SQL

* Высокоуровневый язык программирования с оптимизацией SQL
* Множество типов, возможность структурировать код
* Поддерживает ООП
* Можно разрабатывать веб-приложения

### Отличия синтаксиса SQL в Oracle

* `IDENTITY` для `auto_increment`
* `WHERE ROWNUM < x` и `FETCH FIRST x ROWS ONLY` вместо `LIMIT x`
* `SELECT * FROM a, b WHERE a.id (+)= b.a_id`

### Аналитические функции

* Намного больше, чем в MySQL, примеры:
  `NTH_VALUE`, `PERCENTILE_COUNT`, `REGR_`
* Оптимизированная работа с оконными функциями
* `CUBE` - все возможные комбинации

### Автоматическое создание индексов

* Анализирует историю запросов
* `exec dbms_auto_index.configure('AUTO_INDEX_MODE', 'IMPLEMENT');`

## 6.5 Особенности PostgreSQL

* Хорошая масштабируемость; гибкая, но непростая настройка
* Удобство работы с JSON/XML
* Вложенные транзакции с точками сохранения
* Гибкая система блокировок (lock)
* Расширение PostGIS
* Свободный код, популярная, много расширений
* AWS RedShift

Можно посмотреть детальный разбор команд запроса с помощью `EXPLAIN PLAN`

### Отличия синтаксиса SQL в PostgreSQL

* `SERIAL` вместо `auto_increment`
* `LIMIT`, `OFFSET`
* Альтернативный синтаксис `show tables`, `describe table`, `use`

### PL/SQL в PostgreSQL

* Пользовательский типы данных
* Код на Python
